/*
	AULA 03
*/

/*
	DICA: COLOCAR NÚMERO NAS LINHAS

	TOOLS -> OPTIONS -> TEXT EDITOR -> ALL LANGUAGES -> LINE NUMBERS
	
	DICA: OCULTAR A JANELA DE RESULTADOS
	CTRL+R
*/

/*
	DML -- DATA MANIPULATION LANGUAGE
		-- ** INSERE, ATUALIZA, DELETA E REALIZA CONSULTA AOS REGISTROS

	DDL -- DATA DEFINITION LANGUAGE
		-- ** DEFINIR AS ESTRUTURAS E OS SCHEMAS DE DADOS

	DCL -- DATA CONTROL LANGUAGE
		-- ** ACESSO E SEGURANÇA

	DTL -- DATA TRANSACTION LANGUAGE
		-- ** RESPONSÁVEL PELO CONTROLE E EXECUÇÃO DOS BLOCOS DE OPERAÇÕES/TRANSAÇÕES

*/




/***********************************************************************************

							COMANDOS DDL

***********************************************************************************/



-- APAGAR UM BANCO DE DADOS (DDL)
USE MASTER -- SE DESCONECTA DO BANCO QUE SE QUER APAGAR
DROP DATABASE IF EXISTS PRONTUARIO


-- CRIAR UM NOVO BANCO DE DADOS (DDL)
CREATE DATABASE PRONTUARIO
GO

-- SE CONECTAR A UM DETERMINADO BANCO DE DADOS (DDL)
USE PRONTUARIO
GO


-- CRIAR UM SCHEMA (PREFIXO) PARA A TABELA (DDL)
-- OBS.: CASO NENHUM SCHEMA SEJA DEFINIDO, O PREFIXO PADRÃO É "dbo."
CREATE SCHEMA CLINICA
GO

-- APAGAR UMA TABELA (DDL)
--DROP TABLE CLINICA.MEDICO

-- CRIAR UMA TABELA NO BANCO DE DADOS (DDL)
CREATE TABLE CLINICA.MEDICO
(
	 MEDCODIGO INT NOT NULL /* ou NULL */
	,MEDNOME VARCHAR(100) NOT NULL
	-- CRIA UMA CHAVE PRIMÁRIA PARA A TABELA E DÁ UM ALIAS (APELIDO) PARA A CHAVE PRIMÁRIA
	,CONSTRAINT PK_MEDICO PRIMARY KEY (MEDCODIGO)
)
GO

CREATE TABLE CLINICA.PACIENTE
(
	 PACCODIGO INT NOT NULL
	,PACNOME VARCHAR(100)
	,CONSTRAINT PK_PACIENTE PRIMARY KEY (PACCODIGO)
)
GO

CREATE TABLE CLINICA.MEDICAMENTO
(
	 MDCODIGO INT NOT NULL
	,MDNOME VARCHAR(100)
	,CONSTRAINT PK_MEDICAMENTO PRIMARY KEY (MDCODIGO)
)
GO

CREATE TABLE CLINICA.PRESCRICAO
(
	 CONCODIGO INT NOT NULL
	,MDCODIGO INT NOT NULL
	,POSOLOGIA VARCHAR(200)
)
GO

CREATE TABLE CLINICA.CONSULTA
(
	 MEDCODIGO INT NOT NULL
	,PACCODIGO INT NOT NULL
	,CONCODIGO INT NOT NULL
	,DATA DATE NOT NULL
	-- apesar de 'DATA' ser uma palavra reservada, ela vai aparecer na cor azul.
	-- mas o SQBD entende que se trata de um campo, e ao executar a query ele criará o campo com este nome.
	-- entretanto, caso que queira o nome do campo não fique na cor azul, basta colocá-lo entre conchetes.
	-- ex: ,[DATA] DATE NOT NULL
	,CONSTRAINT PK_CONSULTA PRIMARY KEY (CONCODIGO)
)
GO



-- FORMAS DE SE CRIAR UMA PRIMARY KEY:


-- 1ª MELHOR FORMA
-- CRIAR A CHAVE PRIMÁRIA JUNTAMENTE COM A TABELA E DAR UM ALIAS(APELIDO) PARA ELA.
/*
	CREATE TABLE MEDICO
	(
		 MEDCODIGO INT NOT NULL /* ou NULL */
		,MEDNOME VARCHAR(100) NOT NULL
		-- CRIA UMA CHAVE PRIMÁRIA PARA A TABELA E DÁ UM ALIAS (APELIDO) "PK_MEDICO" 
		-- PARA A CHAVE PRIMÁRIA
		,CONSTRAINT PK_MEDICO PRIMARY KEY (MEDCODIGO)
	)
*/


-- 2ª NÃO IDEAL, MAS AINDA ACEITÁVEL.
-- APÓS CRIAR A TABELA, ALTERAR A TABELA PARA QUE ELA TENHA ADICIONAR A CHAVE PRIMÁRIA.
/*
	-- DDL
	ALTER TABLE PRONTUARIO.CLINICA.MEDICO
		ADD CONSTRAINT PK_MEDICO PRIMARY KEY (MEDCODIGO)
*/


-- 3ª NÃO RECOMENDADO POIS É GERADO UM ALIAS ALEATÓRIO
/*
	CREATE TABLE MEDICAMENTO
	(
		 MDCODIGO INT NOT NULL PRIMARY KEY --(GERA UM ALIAS ALEATÓRIO PARA A CHAVE PRIMÁRIA)
		,MDNOME VARCHAR(100)
	)
*/
	
-- OBS.: NÃO PODE EXISTIR NOME DE CHAVE PRIMÁRIA REPETIDO NO BANCO


 -- CRIANDO FOREING KEY

 ALTER TABLE PRONTUARIO.CLINICA.CONSULTA
	ADD
		 CONSTRAINT FK_MEDICO
		 FOREIGN KEY (MEDCODIGO) -- ESTE CAMPO NÃO PODE SER UMA CHAVE PRIMÁRIA NESTA TABELA.
		 REFERENCES PRONTUARIO.CLINICA.MEDICO (MEDCODIGO) -- ESTE CAMPO PRECISA SER UMA CHAVE PRIMÁRIA DE OUTRA TABELA.
	

		,CONSTRAINT FK_PACIENTE
		 FOREIGN KEY (PACCODIGO)
		 REFERENCES PRONTUARIO.CLINICA.PACIENTE (PACCODIGO)

	
 ALTER TABLE PRONTUARIO.CLINICA.PRESCRICAO
	ADD 
		 CONSTRAINT FK_MEDICAMENTO
		 FOREIGN KEY (MDCODIGO)
		 REFERENCES PRONTUARIO.CLINICA.MEDICAMENTO (MDCODIGO)

		,CONSTRAINT FK_CONSULTA
		 FOREIGN KEY (CONCODIGO)
		 REFERENCES PRONTUARIO.CLINICA.CONSULTA (CONCODIGO)


/*
	CRIAÇÃO DO BANCO, DAS TABELAS E DAS RELAÇÕES ENTRE ELAS CONCLUÍDA.
*/




/***********************************************************************************

							COMANDOS DML

***********************************************************************************/


/*
	** DML

	-- SELECT --> CONSULTA REGISTROS
	-- INSERT INTO --> INSERE REGISTROS
	-- UPDATE --> ATUALIZA REGISTROS
	-- DELETE --> APAGA REGISTROS


	SELECT <[FIELDS]> FROM <[TABLE]> {<[CONDITIONS]> <[GROUPING]> <[ORDERING]>}

	UPDATE <[TABLE]> SET <[FIELDS = VALORES]> {<[CONDITIONS]>}

	DELETE FROM <[TABLE]> {<[CONDITIONS]>}

*/




/*
		POPULANDO AS TABELAS
*/

-- QUANDO A TABELA NÃO TEM CHAVE ESTRANGEIRA, VOCÊ NÃO PRECISA DECLARAR O NOME DOS CAMPOS ANTES DO COMANDO "VALUE".

INSERT INTO PRONTUARIO.CLINICA.PACIENTE
VALUES
	 (1, 'ANDRE LIMA')
	,(2, 'JULIANA DUARTE')
	,(3, 'PAULO HENRIQUE')


INSERT INTO PRONTUARIO.CLINICA.MEDICO
VALUES
	 (1, 'CAROLINA ASSIS')
	,(2, 'JOAO DIAS')


		
INSERT INTO PRONTUARIO.CLINICA.MEDICAMENTO
VALUES
	 (1, 'PARACETAMOL')
	,(2, 'DICLOFENACO DE SODIO')
	,(3, 'PENICILINA')




-- QUANDO A TABELA POSSUI CHAVE ESTRANGEIRA, VOCÊ É OBRIGADO A DECLARAR O NOME DOS CAMPOS ANTES DO COMANDO "VALUE".
			
INSERT INTO PRONTUARIO.CLINICA.CONSULTA
(
	 CONCODIGO
	,MEDCODIGO
	,PACCODIGO
	,[DATA]
)

VALUES
	 (1, 2, 2, '2021-03-01')
	,(2, 1, 1, '2019-10-16')
	,(3, 1, 3, '2020-12-15')



INSERT INTO PRONTUARIO.CLINICA.PRESCRICAO
(
	 CONCODIGO
	,MDCODIGO
	,POSOLOGIA
)

VALUES
	 (1, 3, '500MG 2X AO DIA')
	,(2, 1, '750MG A CADA 8h')
	,(3, 1, '1000MG A CADA 12h')



SELECT * FROM PRONTUARIO.CLINICA.MEDICO
SELECT * FROM PRONTUARIO.CLINICA.PACIENTE
SELECT * FROM PRONTUARIO.CLINICA.MEDICAMENTO
SELECT * FROM PRONTUARIO.CLINICA.PRESCRICAO
SELECT * FROM PRONTUARIO.CLINICA.CONSULTA





-- 4a) Retornar a quantidade de pacientes atendidos no dia 15 de dezembro de 2020;
SELECT 'PACIENTES ATENDIDOS: ' + CAST(COUNT(*) AS VARCHAR)	TOTAL FROM PRONTUARIO.CLINICA.CONSULTA WHERE [DATA] = '2020-12-15'

-- 4b) Retornar o nome dos pacientes atendidos pela médica Carolina Assis;
SELECT
	PC.PACNOME AS 'NOME DO PACIENTE'
FROM PRONTUARIO.CLINICA.PACIENTE		PC
INNER JOIN PRONTUARIO.CLINICA.CONSULTA	CN
	ON PC.PACCODIGO = CN.PACCODIGO
INNER JOIN PRONTUARIO.CLINICA.MEDICO	MD
	ON MD.MEDCODIGO = CN.MEDCODIGO
WHERE MD.MEDNOME = 'CAROLINA ASSIS'

-- 4c) Qual o medicamento receitado para o paciente Paulo Henrique, bem como a posologia indicada pelo profissional.
SELECT
	 MC.MDNOME AS 'NOME DO MEDICAMENTO'
	,PR.POSOLOGIA
FROM PRONTUARIO.CLINICA.PACIENTE			PC
INNER JOIN PRONTUARIO.CLINICA.CONSULTA		CN
	ON CN.PACCODIGO = PC.PACCODIGO
INNER JOIN PRONTUARIO.CLINICA.PRESCRICAO	PR
	ON PR.CONCODIGO = CN.CONCODIGO
INNER JOIN PRONTUARIO.CLINICA.MEDICAMENTO	MC
	ON PR.MDCODIGO = MC.MDCODIGO
WHERE PC.PACNOME = 'PAULO HENRIQUE'









